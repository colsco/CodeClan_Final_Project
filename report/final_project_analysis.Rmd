---
title: 'CodeClan Final Project: UK Productivity'
author: Colin Scotland | DE13
date: "30/05/2022"
output:
  html_document:
    code_folding: hide
    theme: cerulean
    toc: yes
    toc_float: yes
    toc_depth: 4
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: inline
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = FALSE}
library(here)
here::here()

```

```{r}
source(here("data_cleaning/cleaning.R"))
```
# Initial Plots

## UK Output per Hour Ranking v Europe

```{r}
# UK Output per Hour Ranking v Europe ----


europe_labour_prod %>% 
  group_by(country) %>% 
  ggplot() +
  aes(x = reorder(country, value), 
      y = value, 
      group = country, 
      fill = country == "United Kingdom") +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot(show.legend = FALSE) +
  scale_fill_manual(values = c("grey90", "orange")) +
  theme_light(base_size = 10) +
  theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))+
  labs(x = "Country\n",
       y = "Distribution of Output per Hour per Industry (€)",
       title = "Comparison of Industrial Output per Hour in the EU 2014 - 2016 (€)") +
  coord_flip()

```
<br>
The boxplot shows that despite the UK's political stance on the global stage and
it's reputation as a financial powerhouse, in reality the overall productivity
is at best fairly mediocre even when compared to countries within the EU. 

Spain's recent history has seen high unemployment and even depopulation in 
certain interior regions, yet it ranks better than the UK.  Successive UK 
governments have looked to minimise the strength of trade unions, yet countries
in which trade unions remain powerful and are often associated with strike action, 
such as France and Germany are also ranked above the UK.

Ireland, our nearest neighbour with an education and industrial profile very 
similar to the UK comes far higher up in the rankings, which begs the question
"what is UK industry not getting right?".  However, it is also clear that there 
is a lot of overlap throughout all nations, so;

### Is the difference between Norway and the UK statistically significant?

## Hypothesis Test of Significance between UK and Norway Productivity

```{r}
europe_labour_prod %>% 
  group_by(country) %>% 
  filter(country == "Norway"| country == "United Kingdom") %>% 
  ggplot() +
  aes(x = country,  
      y = value, 
      group = country, 
      fill = country == "United Kingdom") +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot(show.legend = FALSE, fill = "grey90") +
  stat_summary(fun.y = "mean", 
               geom = "text", 
               label="mean ------------------------------------", 
               size= 4, 
               color= "orange") +
  theme_light(base_size = 10) +
  labs(x = "Country\n",
       y = "Distribution of Output per Hour per Industry (€)",
       title = "Comparison of Industrial Output per Hour, Norway v UK 2014 - 2016 (€)") 
  
```
<br>
The data for Norway is right-skewed and this has affected the mean relative to 
the overall distribution.  Consequently, median will be used in this hypothesis 
test.

The hypotheses under test are, with α = 0.05;

H0: The average output per hour in Norway is the same as in the UK

$$ H_0 : x͂_{Norway} - x͂_{UK} = 0 $$

H1: The average output per hour in Norway is significantly higher than in the UK

$$ H_1 : x͂_{Norway} - x͂_{UK} > 0 $$
<br>
In this case the median will be used, because the mean (dotted orange line on 
the boxplot above) is badly right skewed by outliers in Norway.

The observed statistic will be the median output per hour in the UK;
```{r}
obs_stat <- europe_labour_prod %>% 
  filter(country == "United Kingdom") %>%
  group_by(country) %>% 
  summarise(avg_uk = median(value))

obs_stat
  
```

Calculate the null sampling distribution;
```{r}
null_distribution <- europe_labour_prod %>% 
  filter(country == "Norway") %>%
  specify(response = value) %>% 
  hypothesize(null = "point", med = 22.67444) %>%
  generate(reps = 50000, type = "bootstrap") %>%
  calculate(stat = "median")
  
```

And now visualise the null distribution;

```{r}
null_distribution %>% 
  visualise(bins = 50) +
  theme_light(base_size = 10) +
  shade_p_value(obs_stat = obs_stat$avg_uk, direction = "right")
```



This gives a p-value of;
```{r}
p_value <- null_distribution %>%
  get_p_value(obs_stat = obs_stat$avg_uk, direction = "right")
p_value
```

The p-value of 0.63 is greater than α = 0.05.  In this case we fail to reject 
the null hypothesis and cannot say that there is a significant difference 
between the median hourly output in Norway when compared to the median hourly 
output in the United Kingdom.

## UK Output per Hour per Industry 

```{r}
# Need a definition of industries - join with industry_dict.

region_by_industry_output_joined <- region_by_industry_output_per_hour %>% 
  left_join(industry_dict, by = "industry") 

# There were some industries grouped together that will need to be explained -
# they have probably been coerced to NAs during the join:

region_by_industry_output_joined %>% 
  filter(is.na(industry_group)) %>% 
  distinct(industry)
```
NAs have been returned only for the industry groupings;

* 'ALLINDUSTRIES'
* 'ABDE'
* 'ST'

For the purposes of this plot;

* 'ALLINDUSTRIES' can be removed.
* 'ABDE' can be defined as 'Agriculture, mining, water, electricity'
* 'ST' can be defined as 'Other services and domestic'

```{r}
region_by_industry_output_joined <- region_by_industry_output_joined %>% 
  mutate(industry_group = 
           if_else(industry == "ABDE", 
                   "agriculture mining water electricity", 
                   industry_group),
         industry_group = 
           if_else(industry == "ST", 
                   "other services and domestic", 
                   industry_group)
         ) %>% 
  filter(!is.na(industry_group))


# Limit timeframe to 2014 - 2016 to maintain consistency with EU data

region_by_industry_output_joined %>% 
  filter(year >= 2014) %>% 
  group_by(industry_group) %>% 
  ggplot() +
  aes(x = reorder(industry_group, pounds_per_hour_worked),
      y = pounds_per_hour_worked,
      group = industry_group) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot(show.legend = FALSE, fill = "grey90") +
  theme_light(base_size = 10) +
  theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))+
  labs(x = "UK Industry in order of Mean Output per Hour\n",
       y = "Distribution of Output per Hour per Industry (£ CVM)",
       title = "Comparison of Output per Hour in UK Industry\n2014 - 2016") +
  scale_x_discrete(labels = wrap_format(40)) +
  coord_flip()

```
<br>
This boxplot shows the distribution of output in pounds per hour worked per 
industry between 2014 - 2016.

The plot clearly shows that real estate was by far the largest contributor to 
financial productivity in this timeframe.

Among the rest of the industries, the plot shows that the hourly output of 
financial, agriculture and information communication contribute on average a 
larger financial output per hour worked than for example, administrative support,
accommodation and arts and entertainment.

It's also clear from the plot that there is a good deal of overlap through almost
all industry groups outside of real estate, i.e. there are no single industry 
groups that stand alone as being worse than all others.  


## UK Output per Hour per Region

```{r}

# Limit timeframe to 2014 - 2016 to maintain consistency with EU data


region_by_industry_output_joined %>% 
  filter(year >= 2014) %>% 
  filter(region != "uk") %>% 
  group_by(region) %>% 
  ggplot() +
  aes(x = reorder(region, pounds_per_hour_worked),
      y = pounds_per_hour_worked,
      group = region) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot(show.legend = FALSE, fill = "grey90") +
  theme_light(base_size = 10) +
  theme(axis.text.x = element_text(angle=90, vjust=.5, hjust=1))+
  labs(x = "UK Region in order of Mean Output per Hour\n",
       y = "Distribution of Pounds Output per Hour per UK Region (£)",
       title = "Comparison of Industrial Output per Hour in UK Regions\n2014 - 2016") +
  scale_x_discrete(labels = wrap_format(40)) +
  coord_flip()
  
```

<br>
Comparison of the hourly output per UK region also shows a lot of overlap, with 
London at the top.  

## Hypothesis Test of Significance between London and Wales

First of all, it would help to visualise this comparison in more detail;

```{r}
region_by_industry_output_joined %>% 
  filter(year >= 2014) %>% 
  filter(region == "london" | region == "wales") %>%
  group_by(region) %>% 
  ggplot() +
  aes(x = region,
      y = pounds_per_hour_worked,
      group = region) +
  stat_boxplot(geom = "errorbar") +
  geom_boxplot(show.legend = FALSE, 
               fill = "grey90") +
  stat_summary(fun.y = "mean", 
               geom = "text", 
               label="mean ------------------------------------", 
               size= 4, 
               color= "orange") +
  theme_light(base_size = 10) +
  labs(x = "UK Region in order of Mean Output per Hour\n",
       y = "Distribution of Pounds Output per Hour per UK Region (£)",
       title = "Comparison of Industrial Output per Hour in London and Wales\n2014 - 2016") +
  scale_x_discrete(labels = wrap_format(40)) +
  coord_cartesian(xlim = c(), ylim = c(0, 100)) 
# Use coord cartesian to limit the axis scales so that the mean and median are
# not affected (they are affected if scale_y_continuous(limits = ) is used)
```
<br>
The hypotheses for this are as follows, with α = 0.05;

H0: The average output per hour in London is the same as in Wales

$$ H_0 : x͂_{London} - x͂_{Wales} = 0 $$

H1: The average output per hour in London is significantly higher than in Wales

$$ H_1 : x͂_{London} - x͂_{Wales} > 0 $$
<br>
In this case the median will be used, because the mean (dotted orange line on 
the boxplot above) is badly right skewed by outliers in both data sets.

The observed statistic will be the median output per hour in Wales;
```{r}
obs_stat <- region_by_industry_output_joined %>% 
  filter(year >= 2014) %>% 
  filter(region == "wales") %>%
  group_by(region) %>% 
  summarise(avg_wales = median(pounds_per_hour_worked))

obs_stat
  
```

Calculate the null sampling distribution;
```{r}
null_distribution <- region_by_industry_output_joined %>% 
  filter(year >= 2014) %>% 
  filter(region == "london") %>%
  specify(response = pounds_per_hour_worked) %>% 
  hypothesize(null = "point", med = 23.18713) %>%
  generate(reps = 50000, type = "bootstrap") %>%
  calculate(stat = "median")
  
```

And now visualise the null distribution;

```{r}
null_distribution %>% 
  visualise(bins = 50) +
  theme_light(base_size = 10) +
  shade_p_value(obs_stat = obs_stat$avg_wales, direction = "right")
```

This gives a p-value of;
```{r}
p_value <- null_distribution %>%
  get_p_value(obs_stat = obs_stat$avg_wales, direction = "right")
p_value
```

The p-value of 0.48 is greater than α = 0.05.  In this case we fail to reject 
the null hypothesis and cannot say that there is a significant difference 
between the median hourly output in London when compared to the median hourly 
output in Wales.

## Output by Industry by Region 

One other point of interest is the output per industry per region;

```{r}

```







# Explanatory Model Setup

The base model data consists of just over 3600 rows.  To set up a test-train 
split it would seem reasonable to split 80 / 20, giving around 3000 rows for
training and just over 500 for testing.

```{r}
test_index <- sample(1:length(model_base_data), 
                     size = length(model_base_data) * 0.2)
```

`industry` and `industry_group` are effectively the same thing, so get rid of
`industry`;
```{r}
model_dev <- model_base_data %>% 
  select(-industry)
  
```


And set non-numeric columns as factors;
```{r}
model_dev %>% 
  mutate(region = as.factor(region),
         industry_group = as.factor(industry_group))
```

Set up the test and train data;

```{r}
model_test <- slice(model_dev, test_index)
model_train <- slice(model_dev, -test_index)
```






#### First Predictor

It's already been seen using ggplot that `industry_group` is significant, with
real estate being far ahead of all other industries.  `industry_group` is a
categorical variable, so should be checked for significance using ANOVA both with 
and without `industry_group` included;

```{r}
anova(lm(pounds_per_hour_worked ~ . -industry_group, data = model_train))
```

Without `industry_group` the main influencing factor is `avg_jobs_000`.  

With `industry_group`;

```{r}
anova(lm(pounds_per_hour_worked ~ .,  data = model_train))
```

It looks like `industry_group` is significant.  So the first model could be;

```{r}
mod1a <- lm(pounds_per_hour_worked ~ industry_group, data = model_train)
```

```{r}
summary(mod1a)
```

This suggests that around 92% of the variance in our model could be explained by
`industry_group`.

Check the diagnostics;
```{r}
autoplot(mod1a, alpha = 0.3)
```

Residuals v fitted are spread across the x-axis with a horizontal line.  Q-Q plot
is on the line for most of it's length, although scale-location doesn't look 
great with an obvious funneling along the x-axis.



